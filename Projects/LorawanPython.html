<html>

<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-159411627-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-159411627-1');
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.2/animate.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=yes">
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
        integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <meta name="Description"
        content="Francisco C Lemos Lisbon, Portugal franciscoclemos.github.io/ Raspberry | IoT | Industrial Automation | Python | LoraWan | Computer Vision"  />
    <title>About | Francisco Lemos</title>
    <link rel="icon" type="image/png" href="/assets/images/space.png">
</head>

<body id="contact-body" style="overflow-x: hidden;">
    <div>
        <nav class="nav-desk">
            <center>
                <div class="nav-logo">
                    <a href="/index.html"><img id="logo" src="/assets/images/home.png"></a>
                </div>
                <div class="nav-items">
                    <ul>
                        <li><span><a href="/About.html">About</a></span></li>
                        <li><span><a href="/work.html">Projects</a></span></li>
                        <li><span><a href="/Repository.html">Repository</a></span></li>
                    </ul>
                </div>

            </center>
        </nav>
        <div class=" fadeIn row" style="width:100vw;height:auto;animation-duration: 1.5s;">
            <div class="col-md-12" id="left-hero">
                <h1 class="hero-tag contact-hero  fadeInLeft">Project X</h1>
                <p class="hero-des contact-des  fadeIn delay-1s">Description project X
                    
                   Devices + LoraWan + TheThingsNetwork
<p 
1.	Parts

Hardware Requirements:
•	ATOM-LITE-ESP32-DEVELOPMENT-KIT - https://shop.m5stack.com/products/atom-lite-esp32-development-kit
•	LoRaWAN UNIT 868MHz (ASR6501) with Antenna -https://shop.m5stack.com/products/lorawan-unit-868mhz-asr6501-with-antenna
•	Proximity to a TTN Gateway – check influence area - https://ttnmapper.org/heatmap/
<p 
Software Requirements:
•	TTN Account - https://www.thethingsnetwork.org/
•	M5Burner - https://shop.m5stack.com/pages/download
•	uPyLoader - https://github.com/BetaRavener/uPyLoader/releases
<p 
2.	Architecture


 
<p 
Notes
•	The current setup uses  the CML IoT LoRaWAN Network Gateways
•	The Things Network uses different frequency plans in different regions of the world. Make sure that the correct version of LoRaWAN devices for Europe the frequency is 868 MHz.

<p 
3.	TheThingsNetwork Setup 
I.	TTN New user
Register as individual user – account is free and must be verified.
 
<p 
II.	TTN New Application – to collect devices data
Navigate to console.
 
<p 
Select Europe Network Cluster
 
<p 
Select “+Add Application” in Applications Menu.
 


<p 
Complete Application Fields and select ‘Create Application’.
 
<p 
III.	TTN New End Device
Under the new Application, select option ‘End Devices’ > ‘Add end device’.
 
<p 
Select ‘Manually’ registration, and the following parametrization.
 
<p 
Select Activation Mode ‘OTAA’, ‘Class C device’ and ‘Use network's default MAC settings’.
 
<p 
Select Options: Generate DevEUI, Fill JoinEUI with zeros, Generate AppKey ans Generate NwkKey. Select ‘Register end device’.
 
<p 
4.	ATOM Lite Setup

 <p 
Erase 
py -m esptool --port com8 -baud 115200 –after no_reset read_mac
flash
py -m esptool --chip esp32 write_flash -z 0x1000 esp32-idf3-20210202-v1.14.bin 
ampy –-port COM8 put lib
ampy –-port COM8 put main.py

<p  
I.	Erase ATOM Lite
a.	Install M5Burner software
b.	Connect ATOM Lite device to PC
c.	Find which COM port is used by device
d.	Select COM port and ‘Erase’
  
<p  
II.	Burn ATOM Lite
a.	Reset ATOM Lite device
b.	Select COM port, ATOM device, UIFLOW(LITE) > ‘Burn’
 
<p  
c.	Reset ATOM Lite device
<p 
III.	Download & Install Libraries
a.	Install uPyLoader
b.	Download Libraries cooperative_multitasking.py, lora_states.py and asr6501.py
c.	Connect uPyLoader to COM port > Select files > Transfer files
 
<p 
IV.	Update & Download main.py
   <p 
a.	Replace DevEUI, JoinEUI and AppKey with new end device Activation Information
<p 
b.	Transfer main.py
c.	Restart device
<p 
5.	Main.py Code
<p 
from cooperative_multitasking import Tasks
from machine import UART
from lora_states import NOT_JOINED, JOINING, JOINED, SENDING, SENT, RETRY
from asr6501 import ASR6501
<p 
tasks = Tasks()
uart2 = UART(2, tx=26, rx=32)
uart2.init(baudrate=115200, bits=8, parity=None, stop=1, txbuf=256, rxbuf=256)
modem = ASR6501(uart2, '70B3D57ED005295F', '0000000000000000', '502F6EDD15D667D30D86F5FD5078F5B6')  # DevEUI, AppEUI, AppKey as hex codes
count = 0

def modem_state_changed():
    return modem.has_state_changed()

def start_join():
    yellow()
    modem.send_join()
    tasks.when_then(modem_state_changed, end_join)
    
def end_join():
    state = modem.get_state()
    if state == JOINING:
        tasks.when_then(modem_state_changed, end_join)
    elif state == JOINED:
        green()
        tasks.after(10000, start_send)
    elif state == NOT_JOINED:
        tasks.after(60000, start_join)
    else:
        raise NotImplementedError()
    
def start_send():
    global count
    count += 1
    blue()
    modem.send_message(bytes(bin(count), 'ASCII'), count % 29 == 1)  # message, confirmed
    tasks.when_then(modem_state_changed, end_send)

def end_send():
    state = modem.get_state()
    if state == SENDING:
        tasks.only_one_of(tasks.when_then(modem_state_changed, end_send), tasks.after(60000, assume_sent))  # workaround for AT+DTRX response lines
    elif state == SENT:
        magenta()
        tasks.after(300000, start_send)
    elif state == RETRY:
        red()
        tasks.after(300000, start_send)
    elif state == NOT_JOINED:
        red()
        tasks.after(300000, start_join)
    else:
        raise NotImplementedError()

def assume_sent():
    magenta()
    tasks.after(240000, start_send)


from machine import Pin
from neopixel import NeoPixel

gpio27 = Pin(27, Pin.OUT)
neopixels = NeoPixel(gpio27, 1)

def yellow():
    neopixels[0] = (20, 20, 0)
    neopixels.write()

def green():
    neopixels[0] = (0, 25, 0)
    neopixels.write()

def blue():
    neopixels[0] = (0, 0, 25)
    neopixels.write()

def magenta():
    neopixels[0] = (20, 0, 20)
    neopixels.write()

def red():
    neopixels[0] = (25, 0, 0)
    neopixels.write()


tasks.now(start_join)

while tasks.available():
    tasks.run()
    
<p 
6.	Results


 
 
 

                    
                </p>
                <!-- <div class="feedback"><a href="https://d474b570.nolt.io/">Have any feedback or suggestion?</a></div> -->
            </div>
        </div>
       
            
            
            
            
        </div>
            <div class="footer-full  fadeIn delay-2s">
                <div id="contact-social" class="social-icons" style="display: inline;">
                    <a target="_blank" href="mailto:franciscoclemos@protonmail.com"><i class="fas fa-envelope"></i></a>
                    <a target="_blank" href="https://github.com/FranciscoCLemos"><i class="fab fa-github"></i></a>
                    <a target="_blank" href="https://www.linkedin.com/in/francisco-cardoso-lemos/"><i class="fab fa-linkedin"></i></a>
                </div>
                <div class="footer-credits">
                    Created by Francisco Lemos. Thanks <a
                        href="https://github.com/ishandeveloper">ishandeveloper</a>
                   for sharing your beautiful template.
                </div>
            </div>
        </div>
        <div class="menu-wrap">
            <input type="checkbox" class="toggler">
            <div class="hamburger">
                <div></div>
            </div>
            <div class="menu">
                <div>
                    <div>
                        <ul>
                            <li><a href="#" style="text-decoration: line-through;">Home</a></li>
                            <li><a href="/About.html">About</a></li>
                            <li><a href="/work.html">Projects</a></li>
                            <li><a href="/Repository.html">Repository</a></li>
                            
                        </ul>
                    </div>
                </div>
            </div>
        </div>
</body>

</html>

